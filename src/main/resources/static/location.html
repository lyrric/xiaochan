<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœ°å€ç®¡ç†</title>
    <!-- å¼•å…¥Vue -->
    <script src="https://unpkg.com/vue@2/dist/vue.js"></script>
    <!-- Element UI JS -->
    <script src="https://unpkg.com/element-ui/lib/index.js"></script>
    <!-- Axios for HTTP requests -->
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <!-- å¼•å…¥Element UI -->
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
    <!-- å¼•å…¥Font Awesomeå›¾æ ‡ -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha512-SfTiTlX6kk+qitfevl/7LibUOeJWlt9rbyDn92a1DqWOw9vWG2MFoays0sgObmWazO5BQPiFucnnEAjpAB+/Sw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <!-- å¼•å…¥è‡ªå®šä¹‰æ ·å¼ -->
    <link rel="stylesheet" href="css/location.css">
</head>
<body>
<div id="app" class="container">
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar">
        <a href="/index.html" class="navbar-brand">
            ğŸ› å°èš•æ´»åŠ¨å¹³å°
        </a>
        <div class="navbar-nav">
            <a href="/index.html" class="nav-link">
                ğŸ  é¦–é¡µ
            </a>
            <a href="#" class="nav-link active">
                ğŸ“ åœ°å€ç®¡ç†
            </a>
            <a href="/notify.html" class="nav-link">
                ğŸ”” é€šçŸ¥ç®¡ç†
            </a>
        </div>
    </nav>
    <!-- åœ°å€åˆ—è¡¨åŒºåŸŸ -->
    <el-card v-if="!isAdding && !isEditing" class="mt-4" style="border-radius: 12px; border: none; box-shadow: 0 2px 12px rgba(0, 0, 0, 0.05);" v-loading="loading">
        <div slot="header" class="card-header">
            <span>å·²ä¿å­˜çš„åœ°å€</span>
            <el-button class="add-address-btn" @click="startAddAddress" :disabled="loading" style="display: flex; align-items: center; gap: 5px;">
                <i class="fa fa-plus"></i> æ–°å¢åœ°å€
            </el-button>
        </div>

        <div v-if="addressList.length === 0" class="empty-state">
            <el-empty description="æš‚æ— ä¿å­˜çš„åœ°å€">
                <el-button class="add-address-btn" @click="startAddAddress" slot="bottom">
                    <i class="fa fa-plus"></i> æ–°å¢ç¬¬ä¸€ä¸ªåœ°å€
                </el-button>
            </el-empty>
        </div>

        <div v-else class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mt-4">
            <el-card
                    v-for="(address, index) in addressList"
                    :key="address.id"
                    class="address-card"
                    :style="{animationDelay: (index * 0.1) + 's'}"
            >
                <div>
                    <div class="address-header">
                        <div class="address-name">
                            <i class="fa fa-map-marker"></i> {{ address.name }}
                        </div>
                    </div>

                    <p class="address-main">{{ address.address }}</p>

                    <div class="operation-buttons">
                        <el-button
                                size="small"
                                class="edit-btn"
                                @click="startEditAddress(address)"
                                :disabled="loading"
                                style="display: flex; align-items: center; gap: 3px;"
                        >
                            <i class="fa fa-pencil"></i> ç¼–è¾‘
                        </el-button>
                        <el-button
                                size="small"
                                class="delete-btn"
                                @click="deleteAddress(address.id, index)"
                                :disabled="loading"
                                style="display: flex; align-items: center; gap: 3px;"
                        >
                            <i class="fa fa-trash"></i> åˆ é™¤
                        </el-button>
                    </div>
                </div>
            </el-card>
        </div>
    </el-card>

    <!-- æ–°å¢åœ°å€è¡¨å• -->
    <el-card v-if="isAdding" class="mt-4" style="border-radius: 12px; border: none; box-shadow: 0 2px 12px rgba(0, 0, 0, 0.05);">
        <div slot="header" class="card-header">
            <span>æ–°å¢åœ°å€</span>
            <el-button type="text" @click="cancelOperation" style="display: flex; align-items: center; gap: 3px;">
                <i class="fa fa-times"></i> å–æ¶ˆ
            </el-button>
        </div>

        <el-form
                :model="form"
                ref="form"
                :rules="rules"
                label-width="100px"
                class="mt-4"
        >
            <!-- åœ°åŒºé€‰æ‹© -->
            <el-form-item
                    label="æ‰€åœ¨åœ°åŒº"
                    prop="region"
            >
                <el-cascader
                        v-model="form.region"
                        :options="regionOptions"
                        :props="regionProps"
                        clearable
                        placeholder="è¯·é€‰æ‹©çœ/å¸‚/åŒº"
                        @change="handleRegionChange"
                        style="width: 100%;"
                ></el-cascader>
            </el-form-item>

            <!-- åœ°å€æœç´¢ -->
            <el-form-item
                    label="è¯¦ç»†åœ°å€"
                    prop="selectedAddress"
                    v-if="form.cityCode"
            >
                <el-autocomplete
                        v-model="form.addressKeyword"
                        :fetch-suggestions="queryAddress"
                        placeholder="è¯·è¾“å…¥è¯¦ç»†åœ°å€"
                        @select="handleAddressSelect"
                        value-key="value"
                        clearable
                        style="width: 100%;"
                >
                    <template slot-scope="{ item }">
                        <div style="line-height: 1.5;">
                            <div style="font-weight: 500; color: #333;">{{ item.title }}</div>
                            <div style="font-size: 12px; color: #666; margin-top: 2px;">{{ item.address }}</div>
                        </div>
                    </template>
                </el-autocomplete>

                <!-- é€‰ä¸­çš„åœ°å€ä¿¡æ¯ -->
                <div v-if="form.selectedAddress" class="selected-address">
                    <p class="title">{{ form.selectedAddress.title }}</p>
                    <p class="detail">{{ form.selectedAddress.address }}</p>
                </div>
            </el-form-item>

            <!-- æ¨é€SPT -->
            <el-form-item
                    label="æ¨é€SPT"
                    prop="spt"
            >
                <el-input
                        v-model="form.spt"
                        placeholder="è¯·è¾“å…¥æ¨é€SPTå†…å®¹ï¼ˆé€‰å¡«ï¼‰"
                        maxlength="100"
                ></el-input>
            </el-form-item>

            <!-- æ¨é€å¼€å…³ -->
            <el-form-item label="æ˜¯å¦æ¨é€">
                <el-switch
                        v-model="form.pushSwitch"
                        active-text="æ˜¯"
                        inactive-text="å¦"
                        active-color="#36b37e"
                ></el-switch>
            </el-form-item>

            <!-- æŒ‰é’®åŒºåŸŸ -->
            <div class="form-actions">
                <el-button @click="cancelOperation" :disabled="loading">å–æ¶ˆ</el-button>
                <el-button type="primary" @click="submitForm" :loading="loading" style="display: flex; align-items: center; gap: 5px;">
                    <i class="fa fa-check"></i> ç¡®å®š
                </el-button>
            </div>
        </el-form>
    </el-card>

    <!-- ç¼–è¾‘åœ°å€è¡¨å• -->
    <el-card v-if="isEditing" class="mt-4" style="border-radius: 12px; border: none; box-shadow: 0 2px 12px rgba(0, 0, 0, 0.05);">
        <div slot="header" class="card-header">
            <span>ç¼–è¾‘åœ°å€</span>
            <el-button type="text" @click="cancelOperation" style="display: flex; align-items: center; gap: 3px;">
                <i class="fa fa-times"></i> å–æ¶ˆ
            </el-button>
        </div>

        <el-form
                :model="form"
                ref="form"
                label-width="100px"
                class="mt-4"
        >
            <!-- åœ°å€ä¿¡æ¯ï¼ˆä¸å¯ç¼–è¾‘ï¼‰ -->
            <el-form-item label="åœ°å€åç§°">
                <el-input v-model="form.name" disabled></el-input>
            </el-form-item>

            <el-form-item label="è¯¦ç»†åœ°å€">
                <el-input v-model="form.address" disabled type="textarea" :rows="2"></el-input>
            </el-form-item>

            <!-- å¯ç¼–è¾‘çš„å†…å®¹ -->
            <el-form-item
                    label="æ¨é€SPT"
                    prop="spt"
            >
                <el-input
                        v-model="form.spt"
                        placeholder="è¯·è¾“å…¥æ¨é€SPTå†…å®¹ï¼ˆé€‰å¡«ï¼‰"
                        maxlength="100"
                ></el-input>
            </el-form-item>

            <el-form-item label="æ˜¯å¦æ¨é€">
                <el-switch
                        v-model="form.pushSwitch"
                        active-text="æ˜¯"
                        inactive-text="å¦"
                        active-color="#36b37e"
                ></el-switch>
            </el-form-item>

            <!-- æŒ‰é’®åŒºåŸŸ -->
            <div class="form-actions">
                <el-button @click="cancelOperation" :disabled="loading">å–æ¶ˆ</el-button>
                <el-button type="primary" @click="updateForm" :loading="loading" style="display: flex; align-items: center; gap: 5px;">
                    <i class="fa fa-check"></i> ä¿å­˜
                </el-button>
            </div>
        </el-form>
    </el-card>
</div>

<script>
    new Vue({
        el: '#app',
        data() {
            return {
                // åœ°å€åˆ—è¡¨
                addressList: [],

                // åœ°åŒºæ•°æ®
                regionOptions: [],

                // çº§è”é€‰æ‹©å™¨é…ç½®
                regionProps: {
                    value: 'code',
                    label: 'name',
                    children: 'child'
                },

                // è¡¨å•æ•°æ®
                form: {
                    id: null,
                    name: '',
                    address: '',
                    region: [], // å­˜å‚¨åœ°åŒºé€‰æ‹©çš„codeæ•°ç»„
                    cityCode: null, // æœ€åä¸€çº§åœ°åŒºçš„code (Integerç±»å‹)
                    addressKeyword: '', // åœ°å€æœç´¢å…³é”®è¯
                    selectedAddress: null, // é€‰ä¸­çš„åœ°å€ä¿¡æ¯
                    spt: '', // æ¨é€SPTå†…å®¹
                    pushSwitch: false // æ˜¯å¦æ¨é€
                },

                // è¡¨å•éªŒè¯è§„åˆ™
                rules: {
                    region: [
                        { required: true, message: 'è¯·é€‰æ‹©æ‰€åœ¨åœ°åŒº', trigger: 'change' }
                    ],
                    selectedAddress: [
                        { required: true, message: 'è¯·é€‰æ‹©è¯¦ç»†åœ°å€', trigger: 'change' }
                    ],
                },

                // çŠ¶æ€æ§åˆ¶
                isAdding: false,
                isEditing: false,
                loading: false
            };
        },
        mounted() {
            this.loadAddressList();
            this.loadRegionOptions();
        },
        methods: {
            // åŠ è½½åœ°å€åˆ—è¡¨
            async loadAddressList() {
                this.loading = true;
                try {
                    const response = await axios.get('/api/location');
                    if (response.data.success) {
                        this.addressList = response.data.data || [];
                    } else {
                        this.$message.error(response.data.msg || 'è·å–åœ°å€åˆ—è¡¨å¤±è´¥');
                    }
                } catch (error) {
                    console.error('è·å–åœ°å€åˆ—è¡¨å¤±è´¥:', error);
                    this.$message.error('è·å–åœ°å€åˆ—è¡¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
                } finally {
                    this.loading = false;
                }
            },
            
            // åŠ è½½åœ°åŒºé€‰é¡¹æ•°æ®
            async loadRegionOptions() {
                try {
                    const response = await axios.get('/api/location/cityCode');
                    if (response.data.success) {
                        this.regionOptions = response.data.data || [];
                    } else {
                        console.error('è·å–åœ°åŒºæ•°æ®å¤±è´¥:', response.data.msg);
                        this.$message.error('è·å–åœ°åŒºæ•°æ®å¤±è´¥');
                    }
                } catch (error) {
                    console.error('è·å–åœ°åŒºæ•°æ®å¤±è´¥:', error);
                    this.$message.error('è·å–åœ°åŒºæ•°æ®å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
                }
            },
            // è¿”å›æŒ‰é’®å¤„ç†
            handleBack() {
                window.location.href = '/index.html';
            },

            // å¼€å§‹æ–°å¢åœ°å€
            startAddAddress() {
                this.isAdding = true;
                this.isEditing = false;
                this.resetForm();
            },

            // å¼€å§‹ç¼–è¾‘åœ°å€
            startEditAddress(address) {
                this.isEditing = true;
                this.isAdding = false;

                // å¡«å……è¡¨å•æ•°æ®ï¼ˆä»…å¯ç¼–è¾‘sptå’ŒpushSwitchï¼‰
                this.form = {
                    id: address.id,
                    name: address.name,
                    address: address.address,
                    spt: address.spt || '',
                    pushSwitch: address.pushSwitch,
                    region: [],
                    cityCode: address.cityCode,
                    addressKeyword: '',
                    selectedAddress: null
                };
            },
        // æŸ¥è¯¢åœ°å€ï¼ˆè°ƒç”¨çœŸå®æ¥å£ï¼‰
        async queryAddress(queryString, callback) {
          if (!this.form.cityCode || !queryString.trim()) {
            callback([]);
            return;
          }
          
          try {
            // è°ƒç”¨çœŸå®çš„åœ°å€æœç´¢æ¥å£
            const response = await axios.get('/api/location/searchAddress', {
              params: {
                keyword: queryString.trim(),
                cityCode: this.form.cityCode
              }
            });
            
            if (response.data.success) {
              // è½¬æ¢æ•°æ®æ ¼å¼ä»¥é€‚é…å‰ç«¯æ˜¾ç¤ºï¼ˆä¸ºel-autocompleteç»„ä»¶å¢åŠ valueå­—æ®µï¼‰
              const addresses = (response.data.data || []).map(item => ({
                value: item.title, // el-autocompleteç»„ä»¶éœ€è¦çš„valueå­—æ®µ
                title: item.title,
                address: item.address,
                latitude: item.latitude,
                longitude: item.longitude,
                cityCode: item.cityCode,
                province: item.province,
                city: item.city,
                district: item.district
              }));
              callback(addresses);
            } else {
              console.error('åœ°å€æœç´¢å¤±è´¥:', response.data.msg);
              callback([]);
            }
          } catch (error) {
            console.error('åœ°å€æœç´¢è¯·æ±‚å¤±è´¥:', error);
            callback([]);
          }
        },
            // å–æ¶ˆæ“ä½œ
            cancelOperation() {
                this.isAdding = false;
                this.isEditing = false;
                this.resetForm();
            },

            // é‡ç½®è¡¨å•
            resetForm() {
                this.form = {
                    id: null,
                    name: '',
                    address: '',
                    region: [],
                    cityCode: null,
                    addressKeyword: '',
                    selectedAddress: null,
                    spt: '',
                    pushSwitch: false
                };

                if (this.$refs.form) {
                    this.$refs.form.resetFields();
                }
            },

            // å¤„ç†åœ°åŒºé€‰æ‹©å˜åŒ–
            handleRegionChange(values) {
                if (values && values.length > 0) {
                    this.form.cityCode = parseInt(values[values.length - 1]);
                } else {
                    this.form.cityCode = null;
                    this.form.selectedAddress = null;
                    this.form.addressKeyword = '';
                }
            },

            // å¤„ç†åœ°å€é€‰æ‹©
            handleAddressSelect(item) {
                this.form.selectedAddress = item;
            },

            // æäº¤æ–°å¢è¡¨å•
            async submitForm() {
                this.$refs.form.validate(async (valid) => {
                    if (valid) {
                        // å‡†å¤‡æäº¤çš„æ•°æ®
                        const submitData = {
                            name: this.form.selectedAddress.title,
                            address: this.form.selectedAddress.address,
                            cityCode: this.form.cityCode,
                            latitude: this.form.selectedAddress.latitude,
                            longitude: this.form.selectedAddress.longitude,
                            spt: this.form.spt || null,
                            pushSwitch: this.form.pushSwitch
                        };

                        this.loading = true;
                        try {
                            const response = await axios.post('/api/location', submitData);
                            if (response.data.success) {
                                this.$message.success('åœ°å€æ–°å¢æˆåŠŸ');
                                // é‡æ–°åŠ è½½åœ°å€åˆ—è¡¨
                                await this.loadAddressList();
                                // é‡ç½®çŠ¶æ€
                                this.isAdding = false;
                                this.resetForm();
                            } else {
                                this.$message.error(response.data.msg || 'åœ°å€æ–°å¢å¤±è´¥');
                            }
                        } catch (error) {
                            console.error('æ–°å¢åœ°å€å¤±è´¥:', error);
                            this.$message.error('æ–°å¢åœ°å€å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
                        } finally {
                            this.loading = false;
                        }
                    }
                });
            },

            // æäº¤æ›´æ–°è¡¨å•
            async updateForm() {
                // å‡†å¤‡æ›´æ–°çš„æ•°æ®ï¼ˆä»…åŒ…å«å¯ç¼–è¾‘çš„å­—æ®µï¼‰
                const updateData = {
                    spt: this.form.spt || null,
                    pushSwitch: this.form.pushSwitch
                };

                this.loading = true;
                try {
                    const response = await axios.put(`/api/location/${this.form.id}`, updateData);
                    if (response.data.success) {
                        this.$message.success('åœ°å€æ›´æ–°æˆåŠŸ');
                        // é‡æ–°åŠ è½½åœ°å€åˆ—è¡¨
                        await this.loadAddressList();
                        // é‡ç½®çŠ¶æ€
                        this.isEditing = false;
                        this.resetForm();
                    } else {
                        this.$message.error(response.data.msg || 'åœ°å€æ›´æ–°å¤±è´¥');
                    }
                } catch (error) {
                    console.error('æ›´æ–°åœ°å€å¤±è´¥:', error);
                    this.$message.error('æ›´æ–°åœ°å€å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
                } finally {
                    this.loading = false;
                }
            },

            // åˆ é™¤åœ°å€
            deleteAddress(id, index) {
                this.$confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªåœ°å€å—ï¼Ÿ', 'æç¤º', {
                    confirmButtonText: 'ç¡®å®š',
                    cancelButtonText: 'å–æ¶ˆ',
                    type: 'warning'
                }).then(async () => {
                    this.loading = true;
                    try {
                        const response = await axios.delete(`/api/location/${id}`);
                        if (response.data.success) {
                            this.$message.success('åœ°å€åˆ é™¤æˆåŠŸ');
                            // é‡æ–°åŠ è½½åœ°å€åˆ—è¡¨
                            await this.loadAddressList();
                        } else {
                            this.$message.error(response.data.msg || 'åœ°å€åˆ é™¤å¤±è´¥');
                        }
                    } catch (error) {
                        console.error('åˆ é™¤åœ°å€å¤±è´¥:', error);
                        this.$message.error('åˆ é™¤åœ°å€å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
                    } finally {
                        this.loading = false;
                    }
                }).catch(() => {
                    this.$message.info('å·²å–æ¶ˆåˆ é™¤');
                });
            }
        }
    });
</script>
</body>
</html>
