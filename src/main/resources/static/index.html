<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°èš•æ´»åŠ¨å¹³å°</title>
    <!-- Element UI CSS -->
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
    <!-- Vue.js -->
    <script src="https://unpkg.com/vue@2/dist/vue.js"></script>
    <!-- Element UI JS -->
    <script src="https://unpkg.com/element-ui/lib/index.js"></script>
    <!-- Axios for HTTP requests -->
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    
    <!-- å¼•å…¥è‡ªå®šä¹‰æ ·å¼ -->
    <link rel="stylesheet" href="css/index.css">
</head>
<body>
    <div id="app">
        <div class="container">
            <!-- å¯¼èˆªæ  -->
            <nav class="navbar">
                <a href="#" class="navbar-brand">
                    ğŸ› å°èš•æ´»åŠ¨å¹³å°
                </a>
                <div class="navbar-nav">
                    <a href="#" class="nav-link active">
                        ğŸ  é¦–é¡µ
                    </a>
                    <a href="/location.html" class="nav-link">
                        ğŸ“ åœ°å€ç®¡ç†
                    </a>
                    <a href="/notify.html" class="nav-link">
                        ğŸ”” é€šçŸ¥ç®¡ç†
                    </a>
                </div>
            </nav>
            
            <!-- å¤´éƒ¨æœç´¢åŒºåŸŸ -->
            <div class="header fade-in">
                <h1 class="header-title">ğŸ› é—¨åº—æŸ¥è¯¢</h1>
                <div class="search-section">
                    <!-- åœ°å€é€‰æ‹©å™¨ -->
                    <div class="address-selector">
                        <el-select
                            v-model="selectedAddressId"
                            :placeholder="addressOptions.length === 0 ? 'è¯·è¾“å…¥å…³é”®è¯æœç´¢åœ°å€' : 'é€‰æ‹©å·²ä¿å­˜çš„åœ°å€'"
                            filterable
                            remote
                            reserve-keyword
                            :remote-method="searchAddresses"
                            :loading="addressLoading"
                            clearable
                            @change="handleAddressChange"
                            @focus="loadLocalAddresses"
                            style="width: 100%"
                        >
                            <el-option
                                v-for="address in addressOptions"
                                :key="address.id"
                                :label="getAddressDisplayName(address)"
                                :value="address.id"
                            >
                                <div class="address-item">
                                    <div class="address-title">{{ getAddressDisplayName(address) }}</div>
                                    <div class="address-detail">{{ address.address }}</div>
                                </div>
                            </el-option>
                        </el-select>
                    </div>
                    
                    <div style="display: flex; gap: 10px; align-items: center;" class="search-input">
                        <el-input
                            v-model="searchForm.name"
                            placeholder="è¯·è¾“å…¥é—¨åº—åç§°"
                            clearable
                            @keyup.enter.native="handleSearch"
                            style="flex: 1;"
                        ></el-input>
                        <el-button 
                            type="primary" 
                            icon="el-icon-search"
                            @click="handleSearch"
                            :loading="loading"
                        >
                            æœç´¢
                        </el-button>
                    </div>
                    
                    <div class="sort-buttons">
                        <el-button-group>
                            <el-button
                                :type="searchForm.orderType === 1 ? 'primary' : 'default'"
                                @click="handleSort(1)"
                            >
                                é»˜è®¤æ’åº
                            </el-button>
                            <el-button
                                :type="searchForm.orderType === 2 ? 'primary' : 'default'"
                                @click="handleSort(2)"
                            >
                                è¿”ç°é‡‘é¢
                            </el-button>
                            <el-button
                                :type="searchForm.orderType === 3 ? 'primary' : 'default'"
                                @click="handleSort(3)"
                            >
                                è¿”ç°æ¯”ä¾‹
                            </el-button>
                        </el-button-group>
                        
                        <el-switch
                            v-model="searchForm.onlyAvailable"
                            active-text="åªçœ‹å¯æŠ¢"
                            inactive-text="æ˜¾ç¤ºå…¨éƒ¨"
                            @change="handleSearch"
                            style="margin-left: 15px;"
                        ></el-switch>
                    </div>
                </div>
            </div>
            
            <!-- å†…å®¹åŒºåŸŸ -->
            <div class="content">
                <!-- åŠ è½½çŠ¶æ€ -->
                <div v-if="loading" class="loading-container">
                    <div class="loading-content">
                        <i class="el-icon-loading"></i>
                        <span>æ­£åœ¨åŠ è½½é—¨åº—ä¿¡æ¯...</span>
                    </div>
                </div>
                
                <!-- ç©ºçŠ¶æ€ -->
                <div v-else-if="storeList.length === 0" class="empty-state">
                    <div class="empty-icon">ğŸª</div>
                    <h3>æš‚æ— é—¨åº—ä¿¡æ¯</h3>
                    <p>è¯·å°è¯•è°ƒæ•´æœç´¢æ¡ä»¶æˆ–ç¨åå†è¯•</p>
                </div>
                
                <!-- é—¨åº—åˆ—è¡¨ -->
                <div v-else>
                    <div 
                        v-for="(store, index) in storeList" 
                        :key="store.promotionId"
                        class="store-card bounce-in"
                        :class="{ 'sold-out': store.leftNumber <= 0 }"
                        :style="{ animationDelay: (index * 0.1) + 's' }"
                    >
                        <div class="store-item">
                            <!-- é—¨åº—å›¾ç‰‡ -->
                            <div class="store-image">
                                <img v-if="store.icon" :src="store.icon" :alt="store.name" />
                                <span v-else>{{ store.name.charAt(0) }}</span>
                            </div>
                            
                            <!-- é—¨åº—ä¿¡æ¯ -->
                            <div class="store-info">
                                <div class="store-name">
                                    {{ store.name }}
                                    <span v-if="store.ifNew" class="new-badge">æ–°åº—</span>
                                    <span :class="getPlatformClass(store.type)">{{ getPlatformName(store.type) }}</span>
                                </div>
                                
                                <div class="store-details">
                                    <div class="detail-item">
                                        <i class="detail-icon el-icon-time"></i>
                                        <span>è¥ä¸šæ—¶é—´ï¼š{{ store.openHours }}</span>
                                    </div>
                                    <div class="detail-item">
                                        <i class="detail-icon el-icon-money"></i>
                                        <span>æ»¡{{ store.price }}è¿”<span class="highlight">{{ store.rebatePrice }}</span></span>
                                    </div>
                                    <div class="detail-item">
                                        <i class="detail-icon el-icon-clock"></i>
                                        <span>æ´»åŠ¨æ—¶é—´ï¼š{{ store.startTime }} - {{ store.endTime }}</span>
                                    </div>
                                    <div class="detail-item">
                                        <i class="detail-icon el-icon-goods"></i>
                                        <span>å‰©ä½™æ•°é‡ï¼š<span :class="store.leftNumber > 0 ? 'success' : 'zero-stock'">
                                            {{ store.leftNumber > 0 ? store.leftNumber : 'å·²å”®ç½„' }}
                                        </span></span>
                                    </div>
                                    <div class="detail-item">
                                        <i class="detail-icon el-icon-star-on"></i>
                                        <span>å¥½è¯„æ¡ä»¶ï¼š{{ getRebateConditionText(store.rebateCondition) }}</span>
                                    </div>
                                    <div class="detail-item">
                                        <i class="detail-icon el-icon-location-outline"></i>
                                        <span>è·ç¦»ï¼š{{ formatDistance(store.distance) }}</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- æ“ä½œæŒ‰é’® -->
                            <div class="store-actions">

                                <el-button
                                    v-if="store.leftNumber <= 0"
                                    type="success"
                                    size="small"
                                    class="action-button"
                                    @click="handleBook(store)"
                                    :loading="actionLoading[store.promotionId + '_book']"
                                >
                                   å¯æŠ¢é€šçŸ¥
                                </el-button>

                            </div>
                        </div>
                    </div>
                    
                    <!-- é€šçŸ¥é…ç½®å¯¹è¯æ¡† -->
                    <el-dialog
                        title="ğŸ”” å¯æŠ¢é€šçŸ¥é…ç½®"
                        :visible.sync="notifyConfigVisible"
                        width="420px"
                        :close-on-click-modal="false"
                        :modal-append-to-body="true"
                        :append-to-body="true"
                        custom-class="notify-config-dialog"
                        :before-close="handleDialogClose"
                    >
                        <div class="dialog-content">
                            <!-- é—¨åº—ä¿¡æ¯å±•ç¤º -->
                            <div v-if="currentNotifyStore" class="store-preview">
                                <div class="store-preview-icon">
                                    <img v-if="currentNotifyStore.icon" :src="currentNotifyStore.icon" :alt="currentNotifyStore.name" />
                                    <span v-else>{{ currentNotifyStore.name.charAt(0) }}</span>
                                </div>
                                <div class="store-preview-info">
                                    <div class="store-preview-name">{{ currentNotifyStore.name }}</div>
                                    <div class="store-preview-detail">æ»¡{{ currentNotifyStore.price }}è¿”{{ currentNotifyStore.rebatePrice }}å…ƒ</div>
                                </div>
                            </div>
                            
                            <el-form :model="notifyConfigForm" :rules="notifyConfigRules" ref="notifyConfigForm" label-width="100px" class="config-form">
                                <el-form-item label="é€šçŸ¥æ–¹å¼" prop="onlyOne">
                                    <el-radio-group v-model="notifyConfigForm.onlyOne" @change="handleRadioChange">
                                        <el-radio :label="true" class="radio-option" :class="{ 'selected': notifyConfigForm.onlyOne === true }">
                                            <div class="radio-content">
                                                <div class="radio-title">ğŸ¯ åªé€šçŸ¥ä¸€æ¬¡</div>
                                                <div class="radio-desc">æœ‰åº“å­˜æ—¶ç«‹å³é€šçŸ¥ï¼Œé€šçŸ¥åè‡ªåŠ¨å–æ¶ˆ</div>
                                            </div>
                                        </el-radio>
                                        <el-radio :label="false" class="radio-option" :class="{ 'selected': notifyConfigForm.onlyOne === false }">
                                            <div class="radio-content">
                                                <div class="radio-title">ğŸ”„ æŒç»­é€šçŸ¥</div>
                                                <div class="radio-desc">æ¯æ¬¡æœ‰åº“å­˜æ—¶éƒ½ä¼šé€šçŸ¥ï¼Œç›´åˆ°æ‰‹åŠ¨å–æ¶ˆ</div>
                                            </div>
                                        </el-radio>
                                    </el-radio-group>
                                </el-form-item>
                                
                                <el-form-item label="æœ‰æ•ˆæœŸ" prop="expireDay">
                                    <div class="expire-setting">
                                        <el-input-number
                                            v-model="notifyConfigForm.expireDay"
                                            :min="1"
                                            :max="365"
                                            controls-position="right"
                                            placeholder="æ°¸ä¹…æœ‰æ•ˆ"
                                            style="width: 140px"
                                        ></el-input-number>
                                        <span class="expire-unit">å¤©</span>
                                        <el-button 
                                            v-if="notifyConfigForm.expireDay" 
                                            size="mini" 
                                            type="text" 
                                            @click="notifyConfigForm.expireDay = null"
                                            class="clear-expire"
                                        >
                                            æ¸…é™¤
                                        </el-button>
                                    </div>
                                    <div class="expire-tip">
                                        ğŸ’¡ ä¸è®¾ç½®æœ‰æ•ˆæœŸåˆ™æ°¸ä¹…æœ‰æ•ˆï¼Œå»ºè®®è®¾ç½®7-30å¤©
                                    </div>
                                </el-form-item>
                            </el-form>
                        </div>
                        
                        <div slot="footer" class="dialog-footer">
                            <el-button @click="handleDialogClose" class="cancel-btn">
                                <i class="el-icon-close"></i>
                                å–æ¶ˆ
                            </el-button>
                            <el-button type="primary" @click="handleNotifyConfigSave" :loading="notifyConfigSaving" class="confirm-btn">
                                <i class="el-icon-check"></i>
                                {{ notifyConfigSaving ? 'ä¿å­˜ä¸­...' : 'ç¡®å®šé…ç½®' }}
                            </el-button>
                        </div>
                    </el-dialog>
                    
                    <!-- æ»šåŠ¨åŠ è½½æ›´å¤šæŒ‡ç¤ºå™¨ -->
                    <div class="scroll-loading-container" v-if="storeList.length > 0">
                        <div 
                            v-if="pagination.isLoadingMore" 
                            class="loading-more"
                        >
                            <i class="el-icon-loading"></i>
                            <span>æ­£åœ¨åŠ è½½æ›´å¤š...</span>
                        </div>
                        
                        <div 
                            v-else-if="!pagination.hasNextPage" 
                            class="no-more-data"
                        >
                            <i class="el-icon-circle-check"></i>
                            <span>å·²åŠ è½½å…¨éƒ¨æ•°æ®</span>
                        </div>
                        
                        <div 
                            v-else 
                            class="load-more-trigger"
                            ref="loadMoreTrigger"
                        >
                            <span>å‘ä¸‹æ»šåŠ¨åŠ è½½æ›´å¤š</span>
                        </div>
                        
                        <div class="pagination-info">
                            å·²åŠ è½½ {{ storeList.length }} æ¡è®°å½•
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        new Vue({
            el: '#app',
            data() {
                return {
                    loading: false,
                    actionLoading: {},
                    searchForm: {
                        name: '',
                        orderType: 1,
                        cityCode: null,
                        latitude: '',
                        longitude: '',
                        onlyAvailable: false,
                        pageNum: 1,
                        pageSize: 30
                    },
                    pagination: {
                        currentPage: 1,
                        hasNextPage: true,
                        isLoadingMore: false
                    },
                    // æ»šåŠ¨ç›‘å¬ç›¸å…³
                    scrollObserver: null,
                    storeList: [],
                    // åœ°å€é€‰æ‹©ç›¸å…³
                    selectedAddress: null,
                    selectedAddressId: null,
                    addressOptions: [],
                    addressLoading: false,
                    // é€šçŸ¥é…ç½®ç›¸å…³
                    notifyConfigVisible: false,
                    notifyConfigSaving: false,
                    notifyConfigForm: {
                        onlyOne: false,
                        expireDay: null
                    },
                    notifyConfigRules: {
                        onlyOne: [
                            { required: true, message: 'è¯·é€‰æ‹©æ˜¯å¦åªé€šçŸ¥ä¸€æ¬¡', trigger: 'change' }
                        ]
                    },
                    currentNotifyStore: null, // å½“å‰é…ç½®é€šçŸ¥çš„é—¨åº—
                    defaultCityCode: 110100 // é»˜è®¤åŒ—äº¬å¸‚åŸå¸‚ç¼–ç 
                }
            },
            mounted() {
                // æ·»åŠ å…¨å±€é”™è¯¯å¤„ç†æ¥å¿½ç•¥æµè§ˆå™¨æ‰©å±•ç›¸å…³é”™è¯¯
                window.addEventListener('error', function(e) {
                    if (e.message && e.message.includes('message port closed')) {
                        // é™é»˜å¿½ç•¥æµè§ˆå™¨æ‰©å±•ç›¸å…³é”™è¯¯
                        e.preventDefault();
                        return false;
                    }
                });
                
                this.getCurrentLocation();
                this.loadSavedAddress();
                this.loadDefaultAddress();
                
                // åˆå§‹åŒ–æ»šåŠ¨ç›‘å¬
                this.initScrollObserver();
                
                // ç›‘å¬é¡µé¢å¯è§æ€§å˜åŒ–ï¼Œå½“ä»å…¶ä»–é¡µé¢è¿”å›æ—¶åˆ·æ–°åœ°å€åˆ—è¡¨
          /*      document.addEventListener('visibilitychange', () => {
                    if (!document.hidden) {
                        // é¡µé¢å˜ä¸ºå¯è§æ—¶ï¼Œåˆ·æ–°åœ°å€åˆ—è¡¨
                        this.refreshAddresses();
                    }
                });*/
            },
            beforeDestroy() {
                // æ¸…ç†æ»šåŠ¨ç›‘å¬å™¨
                if (this.scrollObserver) {
                    this.scrollObserver.disconnect();
                }
            },
            computed: {
                // è®¡ç®—å½“å‰å·²åŠ è½½çš„é¡µæ•°
                loadedPages() {
                    return Math.ceil(this.storeList.length / this.searchForm.pageSize);
                }
            },
            methods: {
                // æœç´¢é—¨åº—
                async handleSearch(resetPage = true) {
                    if (resetPage) {
                        // é‡æ–°æœç´¢æ—¶é‡ç½®åˆ†é¡µï¼ˆæŒ‰è§„èŒƒpageNumä»1å¼€å§‹ï¼‰
                        this.searchForm.pageNum = 1;
                        this.pagination.currentPage = 1;
                        this.pagination.hasNextPage = true;
                    }
                    
                    this.loading = resetPage; // åªæœ‰é‡æ–°æœç´¢æ—¶æ‰æ˜¾ç¤ºä¸»åŠ è½½çŠ¶æ€
                    
                    try {
                        const response = await axios.post('/api/xiaochan/query', this.searchForm);
                        if (response.data.success) {
                            const newData = response.data.data || [];
                            
                            if (resetPage) {
                                // æ–°æœç´¢ï¼Œæ›¿æ¢æ•°æ®
                                this.storeList = newData;
                                console.log(`æ–°æœç´¢å®Œæˆï¼Œè·å–åˆ° ${newData.length} æ¡æ•°æ®`);
                            } else {
                                // åŠ è½½æ›´å¤šï¼Œå°†æ•°æ®è¿½åŠ åˆ°ç°æœ‰åˆ—è¡¨æœ«å°¾ï¼ˆæ— é™æ»šåŠ¨æ ¸å¿ƒé€»è¾‘ï¼‰
                                this.storeList = [...this.storeList, ...newData];
                                console.log(`åŠ è½½ç¬¬ ${this.pagination.currentPage} é¡µï¼Œæ–°å¢ ${newData.length} æ¡æ•°æ®ï¼Œæ€»è®¡ ${this.storeList.length} æ¡`);
                            }
                            
                            // ä¸¥æ ¼æŒ‰ç…§é¡¹ç›®è§„èŒƒï¼šè¿”å›æ•°æ®é‡å°äºpageSizeæ—¶åˆ¤å®šæ— ä¸‹ä¸€é¡µ
                            this.pagination.hasNextPage = newData.length >= this.searchForm.pageSize;
                            
                            if (!this.pagination.hasNextPage && !resetPage) {
                                console.log('å·²åŠ è½½å…¨éƒ¨æ•°æ®ï¼Œæ— æ›´å¤šæ•°æ®');
                            }
                            
                        } else {
                            this.$message.error(response.data.msg || 'æŸ¥è¯¢å¤±è´¥');
                            if (!resetPage) {
                                // åŠ è½½å¤±è´¥æ—¶å›é€€é¡µç 
                                this.pagination.currentPage--;
                                this.searchForm.pageNum = this.pagination.currentPage;
                            }
                        }
                    } catch (error) {
                        console.error('æŸ¥è¯¢å¤±è´¥:', error);
                        this.$message.error('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
                        if (!resetPage) {
                            // åŠ è½½å¤±è´¥æ—¶å›é€€é¡µç 
                            this.pagination.currentPage--;
                            this.searchForm.pageNum = this.pagination.currentPage;
                        }
                    } finally {
                        this.loading = false;
                        this.pagination.isLoadingMore = false;
                        
                        // DOMæ›´æ–°åé‡æ–°åˆå§‹åŒ–æ»šåŠ¨ç›‘å¬å™¨
                        this.$nextTick(() => {
                            this.reinitScrollObserver();
                        });
                    }
                },
                
                // æ’åºå¤„ç†
                handleSort(orderType) {
                    this.searchForm.orderType = orderType;
                    this.handleSearch();
                },
                
                // åˆå§‹åŒ–æ»šåŠ¨ç›‘å¬å™¨ï¼ˆæ— é™æ»šåŠ¨çš„æ ¸å¿ƒå®ç°ï¼‰
                initScrollObserver() {
                    this.$nextTick(() => {
                        // ä½¿ç”¨ Intersection Observer API å®ç°é«˜æ€§èƒ½æ»šåŠ¨ç›‘å¬
                        if (this.$refs.loadMoreTrigger) {
                            this.scrollObserver = new IntersectionObserver(
                                (entries) => {
                                    entries.forEach(entry => {
                                        if (entry.isIntersecting && 
                                            this.pagination.hasNextPage && 
                                            !this.pagination.isLoadingMore && 
                                            !this.loading) {
                                            
                                            console.log('è§¦å‘æ— é™æ»šåŠ¨åŠ è½½');
                                            // è§¦å‘å…ƒç´ è¿›å…¥å¯è§†åŒºåŸŸï¼Œè‡ªåŠ¨åŠ è½½ä¸‹ä¸€é¡µ
                                            this.loadNextPage();
                                        }
                                    });
                                },
                                {
                                    // æå‰300pxè§¦å‘åŠ è½½ï¼Œæå‡ç”¨æˆ·ä½“éªŒ
                                    rootMargin: '300px',
                                    // è®¾ç½®é˜ˆå€¼ï¼Œç¡®ä¿è§¦å‘çš„å‡†ç¡®æ€§
                                    threshold: 0.1
                                }
                            );
                            
                            this.scrollObserver.observe(this.$refs.loadMoreTrigger);
                            console.log('æ— é™æ»šåŠ¨ç›‘å¬å™¨å·²åˆå§‹åŒ–');
                        }
                    });
                },
                
                // é‡æ–°åˆå§‹åŒ–æ»šåŠ¨ç›‘å¬å™¨ï¼ˆåœ¨æ•°æ®æ›´æ–°åè°ƒç”¨ï¼‰
                reinitScrollObserver() {
                    if (this.scrollObserver) {
                        this.scrollObserver.disconnect();
                    }
                    this.initScrollObserver();
                },
                
                // åŠ è½½ä¸‹ä¸€é¡µï¼ˆæ— é™æ»šåŠ¨æ ¸å¿ƒæ–¹æ³•ï¼‰
                async loadNextPage() {
                    if (!this.pagination.hasNextPage || this.pagination.isLoadingMore || this.loading) {
                        console.log('è·³è¿‡åŠ è½½ï¼š', {
                            hasNextPage: this.pagination.hasNextPage,
                            isLoadingMore: this.pagination.isLoadingMore,
                            loading: this.loading
                        });
                        return;
                    }
                    
                    console.log(`å¼€å§‹åŠ è½½ç¬¬ ${this.pagination.currentPage + 1} é¡µ`);
                    this.pagination.isLoadingMore = true;
                    
                    // æŒ‰ç…§é¡¹ç›®è§„èŒƒæ›´æ–°é¡µç ï¼ˆä»1å¼€å§‹ï¼‰
                    this.pagination.currentPage++;
                    this.searchForm.pageNum = this.pagination.currentPage;
                    
                    // å…³é”®ï¼šä¼ å…¥falseç¡®ä¿æ•°æ®è¿½åŠ è€Œä¸æ˜¯æ›¿æ¢
                    await this.handleSearch(false);
                },
                
                // åˆ·æ–°å·²åŠ è½½æ•°æ®ï¼ˆä¿æŒæ— é™æ»šåŠ¨çŠ¶æ€ï¼‰
                async refreshCurrentPageData() {
                    // ä¿å­˜å½“å‰çš„åˆ†é¡µçŠ¶æ€å’Œåˆ—è¡¨é•¿åº¦
                    const originalPageNum = this.searchForm.pageNum;
                    const originalCurrentPage = this.pagination.currentPage;
                    const currentDataLength = this.storeList.length;
                    
                    console.log(`å¼€å§‹åˆ·æ–°æ•°æ®ï¼Œå½“å‰å·²åŠ è½½ ${originalCurrentPage} é¡µï¼Œå…± ${currentDataLength} æ¡æ•°æ®`);
                    
                    try {
                        let allData = [];
                        
                        // é‡æ–°åŠ è½½æ‰€æœ‰å·²åŠ è½½é¡µé¢çš„æ•°æ®ï¼Œä¿æŒæ— é™æ»šåŠ¨çš„è¿ç»­æ€§
                        for (let page = 1; page <= originalCurrentPage; page++) {
                            this.searchForm.pageNum = page;
                            const pageResponse = await axios.post('/api/xiaochan/query', this.searchForm);
                            
                            if (pageResponse.data.success && pageResponse.data.data) {
                                const pageData = pageResponse.data.data;
                                // å°†æ¯é¡µæ•°æ®è¿½åŠ åˆ°æ€»æ•°æ®ä¸­
                                allData = [...allData, ...pageData];
                                
                                console.log(`åˆ·æ–°ç¬¬ ${page} é¡µå®Œæˆï¼Œè·å– ${pageData.length} æ¡æ•°æ®`);
                                
                                // æŒ‰ç…§é¡¹ç›®è§„èŒƒåˆ¤æ–­æ˜¯å¦è¿˜æœ‰ä¸‹ä¸€é¡µ
                                if (page === originalCurrentPage) {
                                    this.pagination.hasNextPage = pageData.length >= this.searchForm.pageSize;
                                }
                                
                                if (pageData.length < this.searchForm.pageSize) {
                                    this.pagination.hasNextPage = false;
                                    break;
                                }
                            } else {
                                console.error(`åˆ·æ–°ç¬¬ ${page} é¡µå¤±è´¥`);
                                break;
                            }
                        }
                        
                        // æ›´æ–°åˆ—è¡¨æ•°æ®ï¼Œä¿æŒåŸæœ‰çš„æ»šåŠ¨çŠ¶æ€
                        this.storeList = allData;
                        console.log(`æ•°æ®åˆ·æ–°å®Œæˆï¼Œæ€»è®¡ ${allData.length} æ¡æ•°æ®`);
                        
                        // é‡æ–°åˆå§‹åŒ–æ»šåŠ¨ç›‘å¬å™¨
                        this.$nextTick(() => {
                            this.reinitScrollObserver();
                        });
                        
                    } catch (error) {
                        console.error('åˆ·æ–°æ•°æ®å¤±è´¥:', error);
                        this.$message.error('åˆ·æ–°æ•°æ®å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
                    } finally {
                        // æ¢å¤åŸæœ‰çš„åˆ†é¡µçŠ¶æ€
                        this.searchForm.pageNum = originalPageNum;
                        this.pagination.currentPage = originalCurrentPage;
                    }
                },
                
                // æŠ¥å
                async handleApply(store) {
                    const loadingKey = store.promotionId + '_apply';
                    this.$set(this.actionLoading, loadingKey, true);
                    
                    try {
                        const response = await axios.post(`/api/xiaochan/apply/${store.promotionId}`);
                        if (response.data.success) {
                            this.$message.success('æŠ¥åæˆåŠŸï¼');
                            // åªæ›´æ–°å½“å‰é¡µæ•°æ®ï¼Œä¸é‡ç½®æ•´ä¸ªåˆ—è¡¨
                            this.refreshCurrentPageData();
                        } else {
                            this.$message.error(response.data.msg || 'æŠ¥åå¤±è´¥');
                        }
                    } catch (error) {
                        console.error('æŠ¥åå¤±è´¥:', error);
                        this.$message.error('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
                    } finally {
                        this.$set(this.actionLoading, loadingKey, false);
                    }
                },
                
                // é¢„çº¦
                async handleBook(store) {
                    // è®¾ç½®å½“å‰é…ç½®çš„é—¨åº—ä¿¡æ¯
                    this.currentNotifyStore = store;
                    
                    // é‡ç½®è¡¨å•
                    this.notifyConfigForm = {
                        onlyOne: false,
                        expireDay: null
                    };
                    
                    // æ˜¾ç¤ºé…ç½®å¯¹è¯æ¡†
                    this.notifyConfigVisible = true;
                },
                
                // å¿½ç•¥
                async handleIgnore(store) {
                    const loadingKey = store.storeId + '_ignore';
                    this.$set(this.actionLoading, loadingKey, true);
                    
                    try {
                        const ignoreData = {
                            storeId: store.storeId.toString(),
                            storeName: store.name,
                            type: store.type,
                            price: store.price,
                            rebatePrice: store.rebatePrice,
                            rebateCondition: store.rebateCondition,
                            icon: store.icon
                        };
                        const response = await axios.post('/api/xiaochan/ignore', ignoreData);
                        if (response.data.success) {
                            this.$message.success('å·²å¿½ç•¥è¯¥é—¨åº—');
                            // åªæ›´æ–°å½“å‰é¡µæ•°æ®ï¼Œä¸é‡ç½®æ•´ä¸ªåˆ—è¡¨
                            this.refreshCurrentPageData();
                        } else {
                            this.$message.error(response.data.msg || 'æ“ä½œå¤±è´¥');
                        }
                    } catch (error) {
                        console.error('å¿½ç•¥å¤±è´¥:', error);
                        this.$message.error('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
                    } finally {
                        this.$set(this.actionLoading, loadingKey, false);
                    }
                },
                
                // è·å–å¹³å°åç§°
                getPlatformName(type) {
                    const platforms = {
                        1: 'ç¾å›¢',
                        2: 'é¥¿äº†ä¹ˆ',
                        3: 'äº¬ä¸œ'
                    };
                    return platforms[type] || 'æœªçŸ¥';
                },
                
                // è·å–å¹³å°æ ·å¼ç±»
                getPlatformClass(type) {
                    const classes = {
                        1: 'platform-tag platform-meituan',
                        2: 'platform-tag platform-eleme',
                        3: 'platform-tag platform-jd'
                    };
                    return classes[type] || 'platform-tag';
                },
                
                // è·å–å¥½è¯„æ¡ä»¶æ–‡æœ¬
                getRebateConditionText(condition) {
                    const conditions = {
                        99: 'æ— éœ€è¯„ä»·',
                        2: 'å›¾æ–‡è¯„ä»·'
                    };
                    return conditions[condition] || 'å…¶ä»–';
                },
                
                // æ ¼å¼åŒ–è·ç¦»
                formatDistance(distance) {
                    if (distance < 1000) {
                        return distance + 'm';
                    } else {
                        return (distance / 1000).toFixed(1) + 'km';
                    }
                },
                
                // åˆ¤æ–­æ˜¯å¦å¯ä»¥æŠ¥å
                canApply(store) {
                    if (store.leftNumber <= 0) return false;
                    
                    // æ£€æŸ¥å½“å‰æ—¶é—´æ˜¯å¦åœ¨æ´»åŠ¨æ—¶é—´å†…
                    const now = new Date();
                    const currentTime = now.getHours().toString().padStart(2, '0') + ':' + 
                                      now.getMinutes().toString().padStart(2, '0');
                    
                    return currentTime >= store.startTime && currentTime <= store.endTime;
                },
                
                // è·å–å½“å‰ä½ç½®
                getCurrentLocation() {
                    if (navigator.geolocation) {
                        navigator.geolocation.getCurrentPosition(
                            (position) => {
                                this.searchForm.latitude = position.coords.latitude.toString();
                                this.searchForm.longitude = position.coords.longitude.toString();
                            },
                            (error) => {
                                console.log('è·å–ä½ç½®å¤±è´¥:', error);
                            }
                        );
                    }
                },
                
            
                // è·³è½¬åˆ°åœ°å€é€‰æ‹©é¡µé¢
                goToAddressPage() {
                    window.open('/location.html', '_blank');
                },
                
                // æœç´¢åœ°å€ - å¦‚æœæœ‰å…³é”®å­—åˆ™æœç´¢è¿œç¨‹åœ°å€ï¼Œå¦åˆ™åŠ è½½æœ¬åœ°ä¿å­˜çš„åœ°å€
                async searchAddresses(keyword) {
                    if (!keyword || keyword.trim().length < 2) {
                        // æ²¡æœ‰å…³é”®å­—æ—¶ï¼Œé‡æ–°åŠ è½½æœ¬åœ°ä¿å­˜çš„åœ°å€åˆ—è¡¨
                        await this.loadLocalAddresses();
                        return;
                    }
                    
                    this.addressLoading = true;
                    this.addressSearchKeyword = keyword;
                    
                    try {
                        // ä½¿ç”¨å½“å‰é€‰ä¸­åœ°å€çš„cityCodeï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨é»˜è®¤åŸå¸‚ç¼–ç 
                        const cityCode = this.selectedAddress?.cityCode || this.defaultCityCode;
                        const response = await axios.get('/api/location/searchAddress', {
                            params: {
                                keyword: keyword.trim(),
                                cityCode: cityCode
                            }
                        });
                        
                        if (response.data.success) {
                            const searchResults = response.data.data || [];
                            // ä¸ºæœç´¢ç»“æœæ·»åŠ æ ‡è®°ï¼Œä¾¿äºåŒºåˆ†æœ¬åœ°åœ°å€å’Œæœç´¢ç»“æœ
                            searchResults.forEach(addr => {
                                addr._isSearchResult = true;
                                // ä¸ºAddressVOç»“æ„æ·»åŠ nameå­—æ®µï¼Œä¿è¯ä¸æœ¬åœ°åœ°å€çš„ä¸€è‡´æ€§
                                if (!addr.name && addr.title) {
                                    addr.name = addr.title;
                                }
                            });
                            this.addressOptions = searchResults;
                        } else {
                            this.$message.error(response.data.msg || 'åœ°å€æœç´¢å¤±è´¥');
                            this.addressOptions = [];
                        }
                    } catch (error) {
                        console.error('åœ°å€æœç´¢å¤±è´¥:', error);
                        this.$message.error('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
                        this.addressOptions = [];
                    } finally {
                        this.addressLoading = false;
                    }
                },
                
                // åŠ è½½æœ¬åœ°ä¿å­˜çš„åœ°å€åˆ—è¡¨
                async loadLocalAddresses() {
                    try {
                        const response = await axios.get('/api/location');
                        if (response.data.success && response.data.data) {
                            // ä¸ºæœ¬åœ°åœ°å€æ·»åŠ æ ‡è®°
                            const localAddresses = response.data.data;
                            localAddresses.forEach(addr => {
                                addr._isLocalAddress = true;
                            });
                            this.addressOptions = localAddresses;
                        }
                    } catch (error) {
                        console.error('åŠ è½½æœ¬åœ°åœ°å€å¤±è´¥:', error);
                    }
                },
                
                // å¤„ç†åœ°å€é€‰æ‹©å˜åŒ–
                handleAddressChange(selectedAddressId) {
                    if (selectedAddressId) {
                        // æ ¹æ®IDæ‰¾åˆ°å¯¹åº”çš„åœ°å€å¯¹è±¡
                        const selectedAddress = this.findAddressById(selectedAddressId);
                        if (selectedAddress) {
                            this.selectedAddress = selectedAddress;
                            
                            // æ›´æ–°æœç´¢è¡¨å•ä¸­çš„åœ°å€ç›¸å…³å‚æ•°
                            this.searchForm.cityCode = parseInt(selectedAddress.cityCode);
                            this.searchForm.latitude = selectedAddress.latitude;
                            this.searchForm.longitude = selectedAddress.longitude;
                            
                            // ä¿å­˜ç”¨æˆ·é€‰æ‹©çš„åœ°å€IDåˆ°localStorage
                            this.saveSelectedAddressId(selectedAddressId);
                            
                            const displayName = this.getAddressDisplayName(selectedAddress);
                            this.$message.success(`å·²é€‰æ‹©åœ°å€: ${displayName}`);
                            
                            // è‡ªåŠ¨è§¦å‘æœç´¢
                            this.handleSearch();
                        }
                    } else {
                        // æ¸…ç©ºåœ°å€é€‰æ‹©æ—¶ï¼Œæ¢å¤é»˜è®¤å€¼
                        this.selectedAddress = null;
                        this.searchForm.cityCode = null;
                        this.searchForm.latitude = '';
                        this.searchForm.longitude = '';
                        
                        // æ¸…é™¤ä¿å­˜çš„åœ°å€ID
                        localStorage.removeItem('selectedAddressId');
                    }
                },
                
                // åŠ è½½é»˜è®¤åœ°å€ï¼ˆè·å–åœ°å€åˆ—è¡¨å¹¶é€‰ä¸­ç¬¬ä¸€ä¸ªæˆ–ä¸Šæ¬¡é€‰æ‹©çš„åœ°å€ï¼‰
                async loadDefaultAddress() {
                    try {
                        // è°ƒç”¨LocationControllerçš„getAllæ–¹æ³•è·å–åœ°å€åˆ—è¡¨
                        const response = await axios.get('/api/location');
                        
                        if (response.data.success && response.data.data && response.data.data.length > 0) {
                            this.addressOptions = response.data.data;
                            console.log('æˆåŠŸè·å–åœ°å€åˆ—è¡¨:', this.addressOptions.length, 'ä¸ªåœ°å€');
                            
                            // è¾“å‡ºåœ°å€åˆ—è¡¨çš„è¯¦ç»†ä¿¡æ¯ï¼Œä¾¿äºè°ƒè¯•
                            this.addressOptions.forEach((addr, index) => {
                                console.log(`åœ°å€ ${index + 1}: ID=${addr.id}, åç§°=${addr.name}`);
                            });
                            
                            // æ£€æŸ¥æ˜¯å¦æœ‰ä¿å­˜çš„åœ°å€ID
                            const savedAddressId = this.getSavedAddressId();
                            console.log('ä¿å­˜çš„åœ°å€ID:', savedAddressId);
                            
                            if (savedAddressId) {
                                // æ ¹æ®ä¿å­˜çš„IDåœ¨åœ°å€åˆ—è¡¨ä¸­æŸ¥æ‰¾å¯¹åº”çš„åœ°å€
                                const foundAddress = this.findAddressById(savedAddressId);
                                if (foundAddress) {
                                    this.selectedAddressId = savedAddressId;
                                    this.selectedAddress = foundAddress;
                                    // ç›´æ¥è®¾ç½®æœç´¢è¡¨å•å‚æ•°ï¼Œä¸è§¦å‘changeäº‹ä»¶é¿å…å¾ªç¯
                                    this.searchForm.cityCode = parseInt(foundAddress.cityCode);
                                    this.searchForm.latitude = foundAddress.latitude;
                                    this.searchForm.longitude = foundAddress.longitude;
                                    
                                    const displayName = this.getAddressDisplayName(foundAddress);
                                    console.log('æˆåŠŸæ¢å¤ä¿å­˜çš„åœ°å€:', displayName, ', ID:', foundAddress.id);
                                    
                                    // é‡è¦ï¼šæ¢å¤åœ°å€åè‡ªåŠ¨è§¦å‘æœç´¢ï¼Œè·å–é—¨åº—æ•°æ®
                                    this.handleSearch();
                                    return;
                                } else {
                                    // å¦‚æœæ ¹æ®IDæ‰¾ä¸åˆ°åœ°å€ï¼Œæ¸…é™¤æ— æ•ˆçš„ä¿å­˜æ•°æ®
                                    localStorage.removeItem('selectedAddressId');
                                    console.log('ä¿å­˜çš„åœ°å€IDæ— æ•ˆï¼Œå·²æ¸…é™¤ã€‚ä¿å­˜çš„ID:', savedAddressId);
                                }
                            }
                            
                            // å¦‚æœæ²¡æœ‰ä¿å­˜çš„åœ°å€æˆ–æ‰¾ä¸åˆ°ä¿å­˜çš„åœ°å€ï¼Œé€‰æ‹©ç¬¬ä¸€ä¸ªåœ°å€
                            const firstAddress = this.addressOptions[0];
                            this.selectedAddressId = firstAddress.id;
                            this.selectedAddress = firstAddress;
                            // ç›´æ¥è®¾ç½®æœç´¢è¡¨å•å‚æ•°
                            this.searchForm.cityCode = parseInt(firstAddress.cityCode);
                            this.searchForm.latitude = firstAddress.latitude;
                            this.searchForm.longitude = firstAddress.longitude;
                            
                            // ä¿å­˜é»˜è®¤é€‰æ‹©
                            this.saveSelectedAddressId(firstAddress.id);
                            
                            const displayName = this.getAddressDisplayName(firstAddress);
                            console.log('ä½¿ç”¨é»˜è®¤åœ°å€(ç¬¬ä¸€ä¸ª):', displayName, ', ID:', firstAddress.id);
                            
                            // é‡è¦ï¼šä½¿ç”¨é»˜è®¤åœ°å€åä¹Ÿè¦è‡ªåŠ¨è§¦å‘æœç´¢ï¼Œè·å–é—¨åº—æ•°æ®
                            this.handleSearch();
                        } else {
                            console.log('åœ°å€åˆ—è¡¨ä¸ºç©ºï¼Œæç¤ºç”¨æˆ·åˆ›å»ºåœ°å€');
                            // åœ°å€åˆ—è¡¨ä¸ºç©ºï¼Œæç¤ºç”¨æˆ·åˆ›å»ºåœ°å€
                            this.showCreateAddressPrompt();
                        }
                    } catch (error) {
                        console.error('è·å–åœ°å€åˆ—è¡¨å¤±è´¥:', error);
                        this.$message.error('è·å–åœ°å€åˆ—è¡¨å¤±è´¥: ' + (error.response?.data?.msg || error.message));
                        // ç½‘ç»œé”™è¯¯æ—¶ä¹Ÿæç¤ºç”¨æˆ·åˆ›å»ºåœ°å€
                        this.showCreateAddressPrompt();
                    }
                },
                
                // æ˜¾ç¤ºåˆ›å»ºåœ°å€æç¤º
                showCreateAddressPrompt() {
                    this.$confirm('æš‚æ— åœ°å€ä¿¡æ¯ï¼Œæ˜¯å¦å‰å¾€åˆ›å»ºåœ°å€ï¼Ÿ', 'æç¤º', {
                        confirmButtonText: 'åˆ›å»ºåœ°å€',
                        cancelButtonText: 'å–æ¶ˆ',
                        type: 'info'
                    }).then(() => {
                        this.goToAddressPage();
                    }).catch(() => {
                        // ç”¨æˆ·å–æ¶ˆï¼Œä½¿ç”¨é»˜è®¤æœç´¢å‚æ•°
                        this.searchForm.cityCode = this.defaultCityCode;
                        // ç”¨æˆ·å–æ¶ˆåˆ›å»ºåœ°å€åï¼Œä¹Ÿè¦è§¦å‘æœç´¢è·å–é—¨åº—æ•°æ®
                        this.handleSearch();
                    });
                },
                
                // åˆ·æ–°åœ°å€åˆ—è¡¨ï¼ˆåœ¨ä»åœ°å€ç®¡ç†é¡µé¢è¿”å›æ—¶å¯ä»¥è°ƒç”¨ï¼‰
                async refreshAddresses() {
                    await this.loadDefaultAddress();
                },
                
                // ä¿å­˜ç”¨æˆ·é€‰æ‹©çš„åœ°å€IDåˆ°localStorage
                saveSelectedAddressId(addressId) {
                    try {
                        console.log('ä¿å­˜åœ°å€é€‰æ‹©ï¼ŒID:', addressId);
                        localStorage.setItem('selectedAddressId', addressId);
                        console.log('å·²ä¿å­˜åœ°å€IDåˆ°localStorage:', addressId);
                    } catch (error) {
                        console.error('ä¿å­˜åœ°å€IDå¤±è´¥:', error);
                    }
                },
                
                // è·å–åœ°å€æ˜¾ç¤ºåç§°ï¼ˆå…¼å®¹Locationå’ŒAddressVOä¸¤ç§æ•°æ®ç»“æ„ï¼‰
                getAddressDisplayName(address) {
                    // Locationæ¨¡å‹ä½¿ç”¨nameå­—æ®µï¼ŒAddressVOæ¨¡å‹ä½¿ç”¨titleå­—æ®µ
                    return address.name || address.title || 'æœªçŸ¥åœ°å€';
                },
                
                // ä»localStorageè·å–ä¿å­˜çš„åœ°å€ID
                getSavedAddressId() {
                    try {
                        return localStorage.getItem('selectedAddressId');
                    } catch (error) {
                        console.error('è·å–ä¿å­˜çš„åœ°å€IDå¤±è´¥:', error);
                        return null;
                    }
                },
                
                // æ ¹æ®ä¿å­˜çš„åœ°å€IDä»åœ°å€åˆ—è¡¨ä¸­æ‰¾åˆ°å¯¹åº”çš„åœ°å€å¯¹è±¡
                findAddressById(addressId) {
                    if (!addressId || !this.addressOptions.length) {
                        return null;
                    }
                    return this.addressOptions.find(addr => addr.id === addressId);
                },
                
                // å¤„ç†å¯¹è¯æ¡†å…³é—­
                handleDialogClose() {
                    this.notifyConfigVisible = false;
                    // é‡ç½®è¡¨å•å’Œå½“å‰é—¨åº—ä¿¡æ¯
                    this.currentNotifyStore = null;
                    if (this.$refs.notifyConfigForm) {
                        this.$refs.notifyConfigForm.resetFields();
                    }
                },
                
                // ä¿å­˜é€šçŸ¥é…ç½®
                async handleNotifyConfigSave() {
                    // è¡¨å•æ ¡éªŒ
                    try {
                        await this.$refs.notifyConfigForm.validate();
                    } catch (error) {
                        return;
                    }
                    
                    if (!this.currentNotifyStore) {
                        this.$message.error('é—¨åº—ä¿¡æ¯ä¸¢å¤±ï¼Œè¯·é‡æ–°æ“ä½œ');
                        return;
                    }
                    
                    this.notifyConfigSaving = true;
                    
                    try {
                        const configData = {
                            type: 1, // 1ï¼šæŒ‡å®šé—¨åº—æ´»åŠ¨æé†’
                            location: this.selectedAddress, // å½“å‰é€‰ä¸­çš„åœ°å€
                            storeExtNotifyConfig: {
                                storeInfo: this.currentNotifyStore,
                                onlyOne:this.notifyConfigForm.onlyOne,
                                expireDay: this.notifyConfigForm.expireDay,
                            },
                        };
                        
                        const response = await axios.post('/api/notify/config', configData);
                        if (response.data.success) {
                            this.$message({
                                message: 'ğŸ‰ é€šçŸ¥é…ç½®ä¿å­˜æˆåŠŸï¼',
                                type: 'success',
                                duration: 3000,
                                showClose: true
                            });
                            this.handleDialogClose();
                        } else {
                            this.$message.error(response.data.msg || 'ä¿å­˜å¤±è´¥');
                        }
                    } catch (error) {
                        console.error('ä¿å­˜é€šçŸ¥é…ç½®å¤±è´¥:', error);
                        this.$message.error('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
                    } finally {
                        this.notifyConfigSaving = false;
                    }
                },
                
                // åŠ è½½ä¿å­˜çš„åœ°å€ï¼ˆåœ¨é¡µé¢åˆå§‹åŒ–æ—¶è°ƒç”¨ï¼‰
                loadSavedAddress() {
                    // æ³¨æ„ï¼šæ­¤æ–¹æ³•åœ¨é¡µé¢åˆå§‹åŒ–æ—¶è°ƒç”¨ï¼Œæ­¤æ—¶åœ°å€åˆ—è¡¨å¯èƒ½è¿˜æœªåŠ è½½
                    // å®é™…çš„åœ°å€æ¢å¤é€»è¾‘åœ¨loadDefaultAddressæ–¹æ³•ä¸­å¤„ç†
                    const savedAddressId = this.getSavedAddressId();
                    if (savedAddressId) {
                        console.log('å‘ç°ä¿å­˜çš„åœ°å€ID:', savedAddressId);
                    }
                },
                
                // å¤„ç†radioæŒ‰é’®æ”¹å˜äº‹ä»¶
                handleRadioChange(value) {
                    // ç¡®ä¿ç•Œé¢æ›´æ–°
                    this.$nextTick(() => {
                        console.log('Radioé€‰æ‹©å˜æ›´ä¸º:', value);
                    });
                }
            }
        });
    </script>
</body>
</html>